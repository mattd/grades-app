language: node_js
node_js:
  - "6"
branches:
  only:
    - develop
    - master
    - /^release/
cache: yarn
before_install:
  - openssl aes-256-cbc -K $encrypted_b5d1c3ab6ab4_key -iv $encrypted_b5d1c3ab6ab4_iv -in config/firebase/secrets.tar.enc -out config/firebase/secrets.tar -d
  - tar xvf config/firebase/secrets.tar
  - export DEPLOY_TARGET="staging" # Catch /^release/ branches as the base case to avoid regexes.
  - if [ "$TRAVIS_BRANCH" == "develop" ]; then export DEPLOY_TARGET="integration"; fi
  - if [ "$TRAVIS_BRANCH" == "master" ]; then export DEPLOY_TARGET="production"; fi
script:
  - npm run preflight
after_success:
  - npm run build:${DEPLOY_TARGET}
  - firebase deploy --token $FIREBASE_TOKEN -P $DEPLOY_TARGET
  - node scripts/update-build $TRAVIS_COMMIT